# Project Vibe-M: System Specification
# Version: 2.1 (Repeat Loop)
# Target: Python CLI Tool (`vibem`)

---

## 1. ê°œìš” ë° í•µì‹¬ ì›ì¹™
ì´ í”„ë¡œì íŠ¸ëŠ” ìœ íŠœë¸Œ ë®¤ì§ ì±„ë„ ìš´ì˜ì„ ìœ„í•œ **ìë™í™” CLI ë„êµ¬ `vibem`**ì„ êµ¬ì¶•í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œëŠ” ëŒ€ìš©ëŸ‰ ë¯¸ë””ì–´ ì²˜ë¦¬ ì‹œì˜ **ì•ˆì •ì„±**ê³¼ **ìˆœìˆ˜ FFmpeg ì„±ëŠ¥ ìµœì í™”**ì…ë‹ˆë‹¤.

### ğŸ›‘ Hard Constraints (ì ˆëŒ€ ì œì•½ ì‚¬í•­)
1.  **NO Pydub**: `pydub` ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
2.  **Pure FFmpeg**: ëª¨ë“  ë¯¸ë””ì–´ ì¡°ì‘(ë³‘í•©, í¬ë¡œìŠ¤í˜ì´ë“œ, ë£¨í”„, ë Œë”ë§)ì€ `ffmpeg-python` ë˜í¼ ë˜ëŠ” `subprocess`ë¥¼ í†µí•´ FFmpeg ëª…ë ¹ì–´ë¡œ ì§ì ‘ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
3.  **Sequential Filter Chain**: ì˜¤ë””ì˜¤ ë³‘í•© ì‹œ ë‹¨ìˆœ `concat`ì´ ì•„ë‹Œ, `acrossfade` í•„í„°ë¥¼ ì‚¬ìš©í•œ **ìˆœì°¨ì  í•„í„° ê·¸ë˜í”„**ë¥¼ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
    *   *Correct Logic:* `[Stream1][Stream2]acrossfade[Merged1]; [Merged1][Stream3]acrossfade[Merged2]...`
4.  **Fail Fast**: ì…ë ¥ íŒŒì¼ëª…ì´ë‚˜ í˜•ì‹ì´ ìŠ¤í™ê³¼ ë‹¤ë¥´ë©´ ì¦‰ì‹œ ì—ëŸ¬ë¥¼ ì¶œë ¥í•˜ê³  ì¢…ë£Œí•´ì•¼ í•©ë‹ˆë‹¤.

---

## 2. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡°
```text
root/
â”œâ”€â”€ MASTER/                      # í”„ë¡œì íŠ¸ í—Œë²•
â”‚   â”œâ”€â”€ MANAGER.md               # ìš´ì˜ ë§ˆìŠ¤í„° í”Œëœ
â”‚   â”œâ”€â”€ LYRICS.md                # ê°€ì‚¬ ê³µí•™ ê·œì¹™
â”‚   â””â”€â”€ STYLE.md                 # ì‚¬ìš´ë“œ/ìŠ¤íƒ€ì¼ ê°€ì´ë“œ
â”‚
â”œâ”€â”€ SERIES/                      # ì‹œë¦¬ì¦ˆë³„ í”„ë¡œì íŠ¸
â”‚   â””â”€â”€ [Series_Name]/
â”‚       â””â”€â”€ [YYYY-MM-DD]/
â”‚           â”œâ”€â”€ concept.md       # (ì„ íƒ) ì»¨ì…‰ ë¬¸ì„œ
â”‚           â”œâ”€â”€ input/
â”‚           â”‚   â”œâ”€â”€ tracks/      # MP3 íŒŒì¼ë“¤ (íŒŒì¼ëª… ê·œì¹™ í•„ìˆ˜ ì¤€ìˆ˜)
â”‚           â”‚   â”œâ”€â”€ loop.mp4     # ë°°ê²½ ë£¨í”„ ì˜ìƒ
â”‚           â”‚   â””â”€â”€ thumb.jpg    # ì¸ë„¤ì¼ ì´ë¯¸ì§€
â”‚           â”œâ”€â”€ work/            # (ìë™ìƒì„±) ì„ì‹œ ì‘ì—… í´ë”
â”‚           â””â”€â”€ output/          # (ìë™ìƒì„±) ìµœì¢… ê²°ê³¼ë¬¼ í´ë”
â”‚
â”œâ”€â”€ vibem.py                     # CLI ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (Click ì‚¬ìš©)
â”œâ”€â”€ vibem.md                     # CLI ìŠ¤í™ (ì´ íŒŒì¼)
â”œâ”€â”€ requirements.txt             # ì˜ì¡´ì„± ëª©ë¡
â”œâ”€â”€ CLAUDE.md                    # Claude Code ì‘ì—… ì§€ì¹¨
â””â”€â”€ .ai/                         # AI ì „ìš© ë©”ëª¨ë¦¬
    â”œâ”€â”€ SESSION.md               # ì„¸ì…˜ ìƒíƒœ ê¸°ë¡
    â””â”€â”€ lessons-learned.md       # ë²„ê·¸ íŒ¨í„´ ê¸°ë¡
```

---

## 3. íŒŒì¼ëª… ê·œì¹™ (Naming Convention)
íŒŒì‹±ì˜ ì •í™•ë„ë¥¼ ìœ„í•´ **Double Underscore (`__`)**ë¥¼ êµ¬ë¶„ìë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

*   **í˜•ì‹:** `NN__Title__Mood__Genre__BPM.mp3`
*   **ì˜ˆì‹œ:** `01__ìƒˆë²½ì˜ë‹¬ë¦¬ê¸°__Energetic__K-Rock__170.mp3`

---

## 4. CLI ì»¤ë§¨ë“œ ëª…ì„¸

### A. `validate`
**ëª©ì :** ì‘ì—… ì‹œì‘ ì „ íŒŒì¼ ë° ì˜¤ë””ì˜¤ ê±´ì „ì„± ì²´í¬ (Health Check).

1.  **File Check:** `input/tracks` í´ë”ì— MP3ê°€ 1ê°œ ì´ìƒ ì¡´ì¬í•˜ëŠ”ì§€, `loop.mp4`, `thumb.jpg`ê°€ ìˆëŠ”ì§€ í™•ì¸.
2.  **Naming Check:** íŒŒì¼ëª…ì´ ìœ„ ì •ê·œì‹ ê·œì¹™(`__`)ì„ ë”°ë¥´ëŠ”ì§€ ê²€ì‚¬. (ìœ„ë°˜ ì‹œ ì •í™•í•œ íŒŒì¼ëª… ë¦¬í¬íŠ¸)
3.  **Audio Integrity:** `ffprobe`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒì„ í™•ì¸.
    *   Duration > 0
    *   Stream Decodable (ì†ìƒ ì—¬ë¶€)
    *   **Sample Rate Consistency:** ëª¨ë“  íŠ¸ë™ì˜ ìƒ˜í”Œ ë ˆì´íŠ¸ê°€ ë™ì¼í•œì§€ í™•ì¸ (ë‹¤ë¥¼ ê²½ìš° ê²½ê³ ).

### B. `preview`
**ëª©ì :** í†¤ì•¤ë§¤ë„ˆ ë° í¬ë¡œìŠ¤í˜ì´ë“œ ìƒíƒœ ì´ˆê³ ì† í™•ì¸. (ì†ë„ ìš°ì„ )

*   **ì˜µì…˜:** `--sec 30` (ê¸°ë³¸ê°’: 30ì´ˆ)
*   **ë¡œì§:**
    1.  `NN` ë²ˆí˜¸ìˆœìœ¼ë¡œ íŠ¸ë™ ì •ë ¬.
    2.  **Sequential Acrossfade** í•„í„° ê·¸ë˜í”„ êµ¬ì„± (Default fade: 0.8s).
    3.  í•„í„°ë§ëœ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì• 30ì´ˆë§Œ ìë¦„ (`atrim`).
    4.  `loop.mp4`ì™€ `thumb.jpg`ë¥¼ í•©ì³ì„œ ë Œë”ë§.
    5.  **ì¤‘ìš”:** ì˜ìƒ ê¸¸ì´ê°€ ì˜¤ë””ì˜¤ ê¸¸ì´(30ì´ˆ)ì— ë”± ë§ì¶° ëë‚˜ë„ë¡ `-shortest` ì˜µì…˜ ì‚¬ìš©.
    6.  *Note:* ì†ë„ë¥¼ ìœ„í•´ ì´ ë‹¨ê³„ì—ì„œëŠ” `ffmpeg-normalize`ë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ.

### C. `pack`
**ëª©ì :** ìœ íŠœë¸Œ ì—…ë¡œë“œìš© ìµœì¢… ê³ í’ˆì§ˆ íŒ¨í‚¤ì§€ ìƒì„±.

*   **ì˜µì…˜:** `--lufs -14 --tp -1.0 --fade 0.8 --repeat 2`
*   **ë¡œì§:**
    1.  **Re-Validate:** ê²€ì¦ ë¡œì§ ì¬ì‹¤í–‰.
    2.  **Normalize (ê°œë³„ ì •ê·œí™”):**
        *   `ffmpeg-normalize` ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©.
        *   Target: **-14 LUFS**, True Peak: **-1.0 dBTP**.
        *   ê²°ê³¼ë¬¼ì€ `work/norm_tracks/`ì— ì €ì¥ (ì›ë³¸ ë®ì–´ì“°ê¸° ê¸ˆì§€).
    3.  **Merge (ë³‘í•©):**
        *   ì •ê·œí™”ëœ íŠ¸ë™ë“¤ì— **Sequential Acrossfade** ì ìš©.
        *   `--repeat N` ì˜µì…˜ìœ¼ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë°˜ë³µ íšŸìˆ˜ ì§€ì • (ê¸°ë³¸ê°’: 2íšŒ).
        *   ì•ˆì •ì„±ì„ ìœ„í•´ `work/merged.wav`ë¡œ ì¤‘ê°„ íŒŒì¼ ì €ì¥ í—ˆìš©.
    4.  **Render (ìµœì¢… ë Œë”ë§):**
        *   Input: `work/merged.wav` + `loop.mp4` + `thumb.jpg`.
        *   Video Loop: ì¬ì¸ì½”ë”© ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ `stream_loop -1` (ë˜ëŠ” concat demuxer) ì‚¬ìš©.
        *   Codec: `libx264` (Video), `aac` (Audio).
        *   **Critical:** `-shortest` ì˜µì…˜ìœ¼ë¡œ ë¬´í•œ ë£¨í”„ ë°©ì§€.
        *   Output: `output/final.mp4`.
    5.  **Artifacts (ì‚°ì¶œë¬¼ ìƒì„±):**
        *   `provenance.md`: ì›ë³¸ íŒŒì¼ëª…, **SHA-256 í•´ì‹œê°’**, ì²˜ë¦¬ ì˜µì…˜, íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í¬í•¨ëœ í‘œ. (ì €ì‘ê¶Œ ì¦ë¹™ìš©)
        *   `draft_description.txt`: ìœ íŠœë¸Œ ì„¤ëª…ë€ ì´ˆì•ˆ (ì¸íŠ¸ë¡œ, íƒ€ì„ìŠ¤íƒ¬í”„, í•´ì‹œíƒœê·¸, ê³ ì •ëŒ“ê¸€).
        *   `upload.csv`: ì»¬ëŸ¼ í—¤ë” [`video_path`, `title`, `description`, `tags`, `thumbnail_path`, `visibility`].
        *   `report.json`: íŠ¸ë™ë³„ ê¸°ìˆ  í†µê³„ (Duration, Peak, Loudness).

### D. `shorts`
**ëª©ì :** YouTube Shortsìš© 9:16 ì„¸ë¡œ ì˜ìƒ ìƒì„±.

*   **ì˜µì…˜:** `--start MM:SS --duration SEC [--title "..."] [--lyric "..."] [--srt file.srt]`
*   **ë¡œì§:**
    1.  **Input:** `input/shorts.mp4` (8~10ì´ˆ ì§§ì€ ì˜ìƒ) + ì§€ì • íŠ¸ë™ì˜ ì˜¤ë””ì˜¤ êµ¬ê°„.
    2.  **Video Loop:** `shorts.mp4`ë¥¼ `stream_loop -1`ë¡œ ì˜¤ë””ì˜¤ ê¸¸ì´ë§Œí¼ ë°˜ë³µ.
    3.  **Crop:** 9:16 ì„¸ë¡œ ë¹„ìœ¨ë¡œ ì¤‘ì•™ í¬ë¡­.
    4.  **Text Overlay (ì„ íƒ):**
        *   `--title`: ì¤‘ì•™ í›… ë¬¸êµ¬ (0~2ì´ˆ í‘œì‹œ, ë¹ ë¥´ê²Œ í‡´ì¥).
        *   `--lyric`: í•˜ë‹¨ ê³ ì • ê°€ì‚¬ (í˜ì´ë“œì¸, ëê¹Œì§€ ìœ ì§€).
        *   `--srt`: ë™ì  ê°€ì‚¬ (SRT ìë§‰ íŒŒì¼).
    5.  **Output:** `output/shorts/short_[TrackName].mp4`.

---

## 5. ì‚¬ìš© ì˜ˆì‹œ

### ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡° ì˜ˆì‹œ
```text
series/
â””â”€â”€ Test_Series/
    â””â”€â”€ 2026-01-18/
        â”œâ”€â”€ input/
        â”‚   â”œâ”€â”€ tracks/
        â”‚   â”‚   â”œâ”€â”€ 01__ë§ˆìŒë°–__Sentimental__RnB-Ballad__100.mp3
        â”‚   â”‚   â”œâ”€â”€ 02__SunsetDream__Calm__Ambient__80.mp3
        â”‚   â”‚   â””â”€â”€ 03__NightRun__Energetic__EDM__128.mp3
        â”‚   â”œâ”€â”€ loop.mp4       # packìš© ë°°ê²½ ì˜ìƒ
        â”‚   â”œâ”€â”€ shorts.mp4     # shortsìš© (8~10ì´ˆ, ë£¨í”„ë¨)
        â”‚   â””â”€â”€ thumb.jpg
        â”œâ”€â”€ work/            # (ìë™ìƒì„±)
        â””â”€â”€ output/          # (ìë™ìƒì„±)
```

### CLI ëª…ë ¹ì–´ ì˜ˆì‹œ
```bash
# í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
python3 vibem.py init SERIES/Test_Series/2026-01-18

# ê²€ì¦
python3 vibem.py validate SERIES/Test_Series/2026-01-18

# ë¯¸ë¦¬ë³´ê¸° (30ì´ˆ)
python3 vibem.py preview SERIES/Test_Series/2026-01-18 --sec 30

# ìµœì¢… íŒ¨í‚¤ì§• (2íšŒ ë°˜ë³µ, ê¸°ë³¸ê°’)
python3 vibem.py pack SERIES/Test_Series/2026-01-18 --lufs -14 --tp -1.0 --fade 0.8

# ìµœì¢… íŒ¨í‚¤ì§• (1íšŒë§Œ, ë°˜ë³µ ì—†ìŒ)
python3 vibem.py pack SERIES/Test_Series/2026-01-18 --repeat 1

# ì‘ì—… í´ë” ì •ë¦¬
python3 vibem.py clean SERIES/Test_Series/2026-01-18

# ìˆì¸  ìƒì„± (shorts.mp4ê°€ ìŒì•… ê¸¸ì´ë§Œí¼ ë£¨í”„ë¨)
python3 vibem.py shorts SERIES/Test_Series/2026-01-18/input/tracks/01__ë§ˆìŒë°–__Sentimental__RnB-Ballad__100.mp3 \
  --start 00:45 --duration 30

# ìˆì¸  + í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´
python3 vibem.py shorts SERIES/Test_Series/2026-01-18/input/tracks/02__SunsetDream__Calm__Ambient__80.mp3 \
  --start 01:00 --duration 40 --title "ì ë“¤ì§€ ëª»í•œ ìƒˆë²½" --lyric "ì—¬ëª…ì²˜ëŸ¼ ìŠ¤ë©°ë“¤ì–´"
```

---

## 6. êµ¬í˜„ ìš”ì²­ ì‚¬í•­
*   ìœ„ ëª…ì„¸ë¥¼ ë§Œì¡±í•˜ëŠ” `vibem.py` ì „ì²´ ì½”ë“œì™€ `requirements.txt`ë¥¼ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤.
*   íŠ¹íˆ **FFmpeg í•„í„° ê·¸ë˜í”„ ìƒì„± ë¡œì§**ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ê²¬ê³ í•˜ê²Œ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤.